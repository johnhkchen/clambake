# State Drift Correction Examples

This document provides detailed examples of state drift scenarios and their automatic correction strategies in My Little Soda's autonomous system.

## Table of Contents

1. [Overview](#overview)
2. [Minor Drift Corrections](#minor-drift-corrections)
3. [Moderate Drift Corrections](#moderate-drift-corrections)
4. [Critical Drift Corrections](#critical-drift-corrections)
5. [Configuration Examples](#configuration-examples)
6. [Monitoring and Reporting](#monitoring-and-reporting)

## Overview

State drift occurs when the actual state of GitHub issues, branches, PRs, or the local workspace diverges from the autonomous system's expectations. The drift correction system automatically detects and resolves these discrepancies using various strategies based on drift severity.

### Drift Severity Levels

- **Minor**: Low-impact changes that don't affect agent safety or work preservation
- **Moderate**: Medium-impact changes that may affect productivity but are recoverable
- **Critical**: High-impact changes that threaten work preservation or agent safety

## Minor Drift Corrections

### Example 1: Label Changes

**Scenario**: Issue labels are modified by another user while agent is working.

```
Initial State:
- Issue #123: labels = ["agent001", "feature", "priority-medium"]

Detected Drift:
- Issue #123: labels = ["agent001", "feature", "priority-high", "urgent"]

Correction: Update local expectations to match GitHub
```

**System Response**:
```bash
[INFO] Drift detected: LabelsChanged { issue_id: 123, severity: Minor }
[INFO] Correction: UpdateLocalState - Updated issue #123 labels to match GitHub
[INFO] Agent continues work - no interruption needed
```

**Code Example**:
```rust
// Detected drift
StateDrift::LabelsChanged {
    issue_id: 123,
    expected: vec!["agent001".to_string(), "feature".to_string(), "priority-medium".to_string()],
    actual: vec!["agent001".to_string(), "feature".to_string(), "priority-high".to_string(), "urgent".to_string()],
    severity: DriftSeverity::Minor,
}

// Applied correction
CorrectionAction::UpdateLocalState {
    new_state: SystemStateField::Issue(ExpectedIssueState {
        issue_id: 123,
        labels: vec!["agent001".to_string(), "feature".to_string(), "priority-high".to_string(), "urgent".to_string()],
        last_modified: Utc::now(),
        // ... other fields
    }),
    reason: "Labels updated by external user".to_string(),
}
```

### Example 2: Workspace File Changes

**Scenario**: External process modifies non-critical files in workspace.

```
Initial State:
- README.md: unchanged
- docs/: unchanged

Detected Drift:
- README.md: modified (typo fix by human)
- docs/guide.md: added (new documentation)

Correction: Document and continue autonomously
```

**System Response**:
```bash
[INFO] Drift detected: WorkspaceFileChanges { severity: Minor }
[INFO] Correction: DocumentDriftAndContinue - Non-critical file changes detected
[INFO] Created drift report: drift-2025-01-15-1234567
[INFO] Agent continues work - no interruption needed
```

## Moderate Drift Corrections

### Example 3: Issue Reassignment (Non-Critical)

**Scenario**: Issue is reassigned to another team member, but work is not urgent.

```
Initial State:
- Issue #456: assigned to "agent001"
- Work in progress: 60% complete

Detected Drift:
- Issue #456: assigned to "human-developer"
- Reason: Human needs to take over for customer demo

Correction: Synchronize state and continue with new assignment
```

**System Response**:
```bash
[WARN] Drift detected: IssueUnexpectedlyAssigned { issue_id: 456, severity: Moderate }
[INFO] Correction: SynchronizeWithGitHub - Issue reassigned, preserving work
[INFO] Created backup branch: agent001/456-backup-20250115
[INFO] Creating issue to track work handoff
[INFO] Autonomous system will pick up next available task
```

**Generated Handoff Issue**:
```markdown
## Work Handoff: Issue #456

**Previous Assignee**: agent001
**New Assignee**: human-developer  
**Completion**: 60% (3 commits, 6 files changed)

### Work Done
- Implemented core feature logic
- Added unit tests for main functionality
- Updated documentation

### Remaining Work
- Integration tests needed
- Error handling edge cases
- Performance optimization

### Branch Information
- **Work branch**: agent001/456-feature-implementation
- **Backup branch**: agent001/456-backup-20250115
- **Commits ahead**: 3

🤖 Generated by autonomous system drift detection
```

### Example 4: Branch Divergence

**Scenario**: Work branch falls behind main due to other PRs being merged.

```
Initial State:
- Branch: agent001/789-refactor
- Commits behind main: 2
- Commits ahead: 4

Detected Drift:
- Branch: agent001/789-refactor
- Commits behind main: 8 (threshold: 5)
- Commits ahead: 4

Correction: Preserve work and resync with main
```

**System Response**:
```bash
[WARN] Drift detected: BranchDiverged { commits_behind: 8, severity: Moderate }
[INFO] Correction: PreserveWorkAndResync - Syncing branch with main
[INFO] Creating work snapshot before rebase
[INFO] Attempting automatic rebase from main
[INFO] Rebase successful - branch synchronized
[INFO] Agent continues work on updated branch
```

**Rebase Process**:
```bash
# Automated rebase steps performed by system
git fetch origin main
git rebase origin/main

# If conflicts occur:
# 1. Attempt automatic resolution for simple conflicts
# 2. Create recovery branch if complex conflicts detected
# 3. Escalate to human if automatic resolution fails
```

## Critical Drift Corrections

### Example 5: Issue Unexpectedly Closed

**Scenario**: Issue is closed while agent is actively working on it.

```
Initial State:
- Issue #999: Open, assigned to "agent001"
- Active work: 4 commits, ready for PR submission

Detected Drift:
- Issue #999: Closed by "project-manager"
- Reason: "Requirements changed, feature no longer needed"

Correction: Preserve work and require manual intervention
```

**System Response**:
```bash
[ERROR] Critical drift detected: IssueUnexpectedlyClosed { issue_id: 999, severity: Critical }
[INFO] Correction: RequireManualIntervention - Work preservation activated
[INFO] Created state snapshot: state-999-20250115-1234567
[INFO] Preserving work branch: agent001/999-feature-implementation
[INFO] Created tracking issue: #1001
[INFO] Autonomous operation paused - manual intervention required
```

**Generated Tracking Issue**:
```markdown
## 🚨 Critical State Drift: Issue #999 Closed During Active Work

### Summary
Issue #999 was unexpectedly closed while agent001 was actively working on it.

**Closed by**: project-manager  
**Closed at**: 2025-01-15 12:34:56 UTC  
**Reason**: Requirements changed, feature no longer needed

### Work Preservation
- **Branch**: agent001/999-feature-implementation ✅ Preserved
- **Commits**: 4 commits ahead of main ✅ Preserved
- **Files modified**: 8 files ✅ Preserved
- **State snapshot**: state-999-20250115-1234567 ✅ Created

### Work Completed
- [x] Core feature implementation (80% complete)
- [x] Unit tests for main functionality  
- [x] Integration with existing system
- [ ] Final testing and cleanup (was in progress)

### Resolution Required
Please review the preserved work and decide on one of the following actions:

1. **Reopen issue** if requirements changed again
2. **Create new issue** for the completed work if it's still valuable
3. **Archive work** if no longer needed (work is safely preserved)

### Manual Actions Needed
```bash
# Option 1: Continue work under new issue
gh issue create --title "Continue work from #999" --body "..."
git checkout agent001/999-feature-implementation

# Option 2: Archive and cleanup  
git branch -D agent001/999-feature-implementation
my-little-soda reset --clear-state

# Option 3: Merge partial work to main
git checkout main
git merge agent001/999-feature-implementation
```

**Labels**: `critical`, `drift-detection`, `manual-intervention-required`, `agent001`

🤖 Generated by autonomous system drift detection - requires human review
```

### Example 6: Work Branch Deleted

**Scenario**: Agent's work branch is deleted while commits are unpushed.

```
Initial State:
- Branch: agent001/111-optimization  
- Local commits: 3 (unpushed)
- Work status: In progress

Detected Drift:
- Branch: agent001/111-optimization deleted from remote
- Local commits: 3 (now orphaned)
- Deletion by: "repo-maintainer" (cleanup operation)

Correction: Create recovery branch and escalate
```

**System Response**:
```bash
[ERROR] Critical drift detected: BranchDeleted { branch_name: "agent001/111-optimization", severity: Critical }
[INFO] Correction: CreateRecoveryBranch - Preserving orphaned work
[INFO] Created recovery branch: agent001/111-optimization-recovered
[INFO] Pushed recovery branch to remote
[INFO] Created incident issue: #1002
[INFO] Autonomous operation paused - manual review required
```

**Recovery Actions**:
```bash
# Automatic recovery steps performed:
git checkout -b agent001/111-optimization-recovered
git push -u origin agent001/111-optimization-recovered

# Preserved work:
# - All local commits maintained
# - Branch history intact  
# - Work state snapshot created
# - Recovery branch pushed to remote
```

## Configuration Examples

### Basic Drift Detection Configuration

```toml
# my-little-soda.toml
[autonomous.drift_detection]
enable_drift_detection = true
validation_interval_minutes = 5
max_validation_interval_idle = 30

[autonomous.drift_detection.thresholds]
max_commits_behind = 10
critical_drift_types = [
    "IssueUnexpectedlyClosed",
    "BranchDeleted", 
    "PRUnexpectedlyMerged",
    "GitStateInconsistent"
]
```

### Advanced Correction Strategies

```toml
[autonomous.drift_detection.correction]
strategies = [
    "WorkPreserving",           # Always preserve work first
    "GitHubAuthoritative",      # Trust GitHub state over local
    "EscalateAndContinue",      # Create issues but keep working
]

# Work preservation settings
preserve_partial_work = true
create_backup_branches = true
max_backup_retention_days = 30

# Escalation settings  
create_drift_issues = true
notify_on_critical_drift = true
pause_on_critical_drift = true
```

### Environment Variables

```bash
# Core drift detection
export MY_LITTLE_SODA_ENABLE_DRIFT_DETECTION=true
export MY_LITTLE_SODA_DRIFT_VALIDATION_INTERVAL=3

# Thresholds
export MY_LITTLE_SODA_MAX_COMMITS_BEHIND=15
export MY_LITTLE_SODA_DRIFT_SEVERITY_THRESHOLD="Moderate"

# Correction behavior
export MY_LITTLE_SODA_PRESERVE_WORK_ON_DRIFT=true
export MY_LITTLE_SODA_CREATE_DRIFT_ISSUES=true
export MY_LITTLE_SODA_PAUSE_ON_CRITICAL_DRIFT=true
```

## Monitoring and Reporting

### Drift Detection Status

```bash
# Check current drift detection status
./target/release/my-little-soda drift-report

# Example output:
# Drift Detection Report - Agent: agent001
# ================================
# Total drifts detected: 12
# Critical drifts: 1
# Last validation: 2025-01-15 12:30:00 UTC  
# Next validation: 2025-01-15 12:35:00 UTC
# Validation health: Warning
#
# Recent Drifts:
# - Issue #123: LabelsChanged (Minor) - 5 min ago ✅ Corrected
# - Issue #456: IssueUnexpectedlyAssigned (Moderate) - 15 min ago ✅ Corrected  
# - Issue #999: IssueUnexpectedlyClosed (Critical) - 1 hour ago ⚠️ Manual intervention required
```

### Correction History

```bash
# View correction history  
./target/release/my-little-soda correction-history

# Example output:
# Correction History - Last 24 Hours
# =================================
# 
# 2025-01-15 12:25:00 - Issue #123
# Drift: LabelsChanged (Minor)
# Action: UpdateLocalState  
# Result: ✅ Success (0.1s)
# 
# 2025-01-15 12:10:00 - Issue #456  
# Drift: IssueUnexpectedlyAssigned (Moderate)
# Action: SynchronizeWithGitHub
# Result: ✅ Success (2.3s)
# Created: Issue #1000 (handoff tracking)
#
# 2025-01-15 11:30:00 - Issue #999
# Drift: IssueUnexpectedlyClosed (Critical)  
# Action: RequireManualIntervention
# Result: ⚠️ Requires manual review
# Created: Issue #1001 (manual intervention)
# Preserved: Branch agent001/999-feature-implementation
```

### Performance Metrics

```bash
# Check drift detection performance
./target/release/my-little-soda status --drift-performance

# Example output:
# Drift Detection Performance
# ==========================
# Average validation time: 0.8s
# Validations per hour: 12
# Success rate: 95.2%
# 
# Correction Performance:
# - Minor corrections: 0.1s average
# - Moderate corrections: 1.5s average  
# - Critical corrections: 3.2s average
# 
# Work Preservation:
# - Branches preserved: 3
# - Commits preserved: 15
# - Zero work lost: ✅
```

### Alerting Integration

```bash
# Configure alerts for critical drifts
export MY_LITTLE_SODA_SLACK_WEBHOOK="https://hooks.slack.com/..."
export MY_LITTLE_SODA_EMAIL_ALERTS="admin@company.com"

# Alert triggers:
# - Critical drift detected
# - Work preservation activated  
# - Manual intervention required
# - Autonomous operation paused
```

## Best Practices

### Drift Prevention

1. **Coordinate with team** - Communicate when making changes to agent-assigned issues
2. **Use branch protection** - Prevent accidental deletion of agent work branches
3. **Regular monitoring** - Check drift reports periodically
4. **Proper labeling** - Use consistent labeling to help drift detection

### Drift Response

1. **Review drift issues promptly** - Don't let manual intervention requests sit unresolved
2. **Validate corrections** - Check that automatic corrections are appropriate  
3. **Preserve important work** - Never delete agent branches without reviewing content
4. **Update expectations** - Adjust drift thresholds based on your team's workflow

### Configuration Tuning

1. **Start conservative** - Use shorter validation intervals initially
2. **Monitor performance** - Watch for validation overhead  
3. **Adjust thresholds** - Tune based on your repository's activity patterns
4. **Test corrections** - Validate that correction strategies work for your workflow

For more information about configuring and using the drift detection system, see the [autonomous system documentation](../README.md#autonomous-system-features).